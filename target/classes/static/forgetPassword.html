<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老人监护系统 - 找回密码</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .forgot-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 400px;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .forgot-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .forgot-header h1 {
            color: #3a7bd5;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .forgot-header p {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: #3a7bd5;
            outline: none;
            box-shadow: 0 0 0 2px rgba(58, 123, 213, 0.2);
        }

        .code-group {
            display: flex;
            gap: 10px;
        }

        .code-input {
            flex: 1;
        }

        .get-code-btn {
            padding: 0 15px;
            background-color: #f0f0f0;
            color: #3a7bd5;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .get-code-btn:hover {
            background-color: #e0e0e0;
        }

        .get-code-btn:disabled {
            background-color: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background-color: #3a7bd5;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .reset-btn:hover {
            background-color: #2c5fb3;
        }

        .back-login {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .back-link {
            color: #3a7bd5;
            text-decoration: none;
            transition: color 0.3s;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            color: #2ecc71;
            font-size: 14px;
            margin-top: 10px;
            display: none;
            text-align: center;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #eee;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 1;
        }

        .step.active {
            background-color: #3a7bd5;
            color: white;
        }

        .step.completed {
            background-color: #2ecc71;
            color: white;
        }

        .progress-line {
            position: absolute;
            height: 2px;
            background-color: #eee;
            top: 15px;
            left: 15px;
            right: 15px;
            z-index: 0;
        }

        .progress-active {
            position: absolute;
            height: 2px;
            background-color: #3a7bd5;
            top: 15px;
            left: 15px;
            width: 0;
            z-index: 1;
            transition: width 0.3s;
        }

        .step-text {
            position: absolute;
            top: 35px;
            font-size: 12px;
            color: #999;
            width: 100px;
            left: -35px;
            text-align: center;
        }

        .step.active .step-text {
            color: #3a7bd5;
        }

        .step.completed .step-text {
            color: #2ecc71;
        }
    </style>
</head>
<body>
    <div class="forgot-container">
        <div class="steps">
            <div class="step active" id="step1">
                <span>1</span>
                <div class="step-text">验证身份</div>
            </div>
            <div class="step" id="step2">
                <span>2</span>
                <div class="step-text">重置密码</div>
            </div>
            <div class="step" id="step3">
                <span>3</span>
                <div class="step-text">完成</div>
            </div>
            <div class="progress-line"></div>
            <div class="progress-active" id="progressActive"></div>
        </div>

        <div class="forgot-header">
            <h1>找回密码</h1>
            <p>请输入您的账户信息，我们将帮助您重置密码</p>
        </div>

        <form id="forgotForm">
            <!-- 第一步：验证身份 -->
            <div class="form-step" id="step1Form">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" placeholder="请输入您的用户名" required>
                    <div class="error-message" id="usernameError"></div>
                </div>

                <div class="form-group">
                    <label for="phone">手机号码</label>
                    <div class="code-group">
                        <input type="tel" id="phone" name="phone" class="code-input" placeholder="请输入绑定的手机号" required>
                        <button type="button" class="get-code-btn" id="getCodeBtn">获取验证码</button>
                    </div>
                    <div class="error-message" id="phoneError"></div>
                </div>

                <div class="form-group">
                    <label for="code">验证码</label>
                    <input type="text" id="code" name="code" placeholder="请输入短信验证码" required>
                    <div class="error-message" id="codeError"></div>
                </div>

                <button type="button" class="reset-btn" id="nextStep1Btn">下一步</button>
            </div>

            <!-- 第二步：重置密码 -->
            <div class="form-step" id="step2Form" style="display: none;">
                <div class="form-group">
                    <label for="newPassword">新密码</label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="请输入新密码(至少6位)" required>
                    <div class="error-message" id="newPasswordError"></div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">确认密码</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="请再次输入新密码" required>
                    <div class="error-message" id="confirmPasswordError"></div>
                </div>

                <button type="button" class="reset-btn" id="nextStep2Btn">提交</button>
            </div>

            <!-- 第三步：完成 -->
            <div class="form-step" id="step3Form" style="display: none; text-align: center;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 20px;">
                    <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="#2ecc71" stroke-width="2" stroke-linecap="round"/>
                    <path d="M22 4L12 14.01L9 11.01" stroke="#2ecc71" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h2 style="color: #2ecc71; margin-bottom: 10px;">密码重置成功！</h2>
                <p style="color: #666; margin-bottom: 20px;">您已成功重置密码，请使用新密码登录</p>
                <a href="login.html" class="reset-btn" style="text-decoration: none; display: inline-block; width: auto; padding: 10px 30px;">返回登录</a>
            </div>
        </form>

        <div class="success-message" id="successMessage"></div>

        <div class="back-login">
            <a href="login.html" class="back-link">返回登录</a>
        </div>
    </div>

    <script>
        // 当前步骤
        let currentStep = 1;
        let countdown = 0;
        let countdownInterval;

        // 下一步按钮点击事件
        document.getElementById('nextStep1Btn').addEventListener('click', function() {
            if (validateStep1()) {
                goToStep(2);
            }
        });

        // 提交按钮点击事件
        document.getElementById('nextStep2Btn').addEventListener('click', function() {
            if (validateStep2()) {
                const username = document.getElementById('username').value;
                const newPassword = document.getElementById('newPassword').value;
                resetPassword(username, newPassword);
            }
        });

        // 获取验证码按钮点击事件
        document.getElementById('getCodeBtn').addEventListener('click', function() {
            const phone = document.getElementById('phone').value.trim();

            if (!phone) {
                showError('phoneError', '请输入手机号码');
                return;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showError('phoneError', '请输入有效的手机号码');
                return;
            }

            // 禁用按钮并开始倒计时
            this.disabled = true;
            countdown = 60;
            updateCountdown();

            // 模拟发送验证码
            console.log('发送验证码到手机:', phone);
            showSuccess('验证码已发送，请注意查收');

            // 开始倒计时
            countdownInterval = setInterval(updateCountdown, 1000);
        });

        // 更新倒计时显示
        function updateCountdown() {
            const btn = document.getElementById('getCodeBtn');

            if (countdown > 0) {
                btn.textContent = `${countdown}秒后重试`;
                countdown--;
            } else {
                btn.textContent = '获取验证码';
                btn.disabled = false;
                clearInterval(countdownInterval);
            }
        }

        // 验证第一步
        function validateStep1() {
            const username = document.getElementById('username').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const code = document.getElementById('code').value.trim();

            // 重置错误消息
            hideAllErrors();

            let isValid = true;

            if (!username) {
                showError('usernameError', '请输入用户名');
                isValid = false;
            }

            if (!phone) {
                showError('phoneError', '请输入手机号码');
                isValid = false;
            } else if (!/^1[3-9]\d{9}$/.test(phone)) {
                showError('phoneError', '请输入有效的手机号码');
                isValid = false;
            }

            if (!code) {
                showError('codeError', '请输入验证码');
                isValid = false;
            } else if (code.length !== 6) {
                showError('codeError', '验证码应为6位数字');
                isValid = false;
            }

            return isValid;
        }

        // 验证第二步
        function validateStep2() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // 重置错误消息
            hideAllErrors();

            let isValid = true;

            if (newPassword.length < 6) {
                showError('newPasswordError', '密码至少需要6位');
                isValid = false;
            }

            if (newPassword !== confirmPassword) {
                showError('confirmPasswordError', '两次输入的密码不一致');
                isValid = false;
            }

            return isValid;
        }

        // 跳转到指定步骤
        function goToStep(step) {
            // 更新当前步骤
            currentStep = step;

            // 更新进度条
            updateProgress();

            // 隐藏所有步骤表单
            document.querySelectorAll('.form-step').forEach(el => {
                el.style.display = 'none';
            });

            // 显示当前步骤表单
            document.getElementById(`step${step}Form`).style.display = 'block';

            // 滚动到顶部
            window.scrollTo(0, 0);
        }

        // 更新进度条和步骤状态
        function updateProgress() {
            const progress = document.getElementById('progressActive');

            // 更新进度条宽度
            if (currentStep === 1) {
                progress.style.width = '0';
            } else if (currentStep === 2) {
                progress.style.width = '50%';
            } else if (currentStep === 3) {
                progress.style.width = '100%';
            }

            // 更新步骤状态
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);

                if (i < currentStep) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            }
        }

        // 显示错误消息
        function showError(id, message) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.style.display = 'block';
        }

        // 隐藏所有错误消息
        function hideAllErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
        }

        // 显示成功消息
        function showSuccess(message) {
            const element = document.getElementById('successMessage');
            element.textContent = message;
            element.style.display = 'block';

            // 5秒后自动隐藏
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function resetPassword(username, newPassword) {
            fetch('/api/auth/resetPassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    newPassword
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.flag) {
                        alert(data.message);
                        window.location.href = '/login.html';
                    } else {
                        alert('密码重置失败，请检查输入');
                    }
                })
                .catch(err => {
                    console.error('密码重置错误:', err);
                    alert('网络错误，请稍后重试');
                });
        }

    </script>
</body>
</html>
